<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Fabric 入门 | thr's blog</title><meta name="author" content="thr"><meta name="copyright" content="thr"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Fabric 官方文档：关键概念 — hyperledger-fabricdocs master 文档  1. 关键概念1.1 区块链网络 这个 Fabric 区块链网络包括了两个应用程序通道以及一个排序通道。 组织 R1 和 R4 负责排序通道，R1 和 R2 负责蓝色的应用程序通道，R2 和 R3 负责红色的应用程序通道。 客户端应用程序 A1 是组织 R1 的元素，CA1 是它的证书颁发机构">
<meta property="og:type" content="article">
<meta property="og:title" content="Fabric 入门">
<meta property="og:url" content="https://tangsmallrong.github.io/2023/11/18/Fabric%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="thr&#39;s blog">
<meta property="og:description" content="Fabric 官方文档：关键概念 — hyperledger-fabricdocs master 文档  1. 关键概念1.1 区块链网络 这个 Fabric 区块链网络包括了两个应用程序通道以及一个排序通道。 组织 R1 和 R4 负责排序通道，R1 和 R2 负责蓝色的应用程序通道，R2 和 R3 负责红色的应用程序通道。 客户端应用程序 A1 是组织 R1 的元素，CA1 是它的证书颁发机构">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tangsmallrong.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2023-11-18T02:41:20.000Z">
<meta property="article:modified_time" content="2023-11-18T13:17:22.240Z">
<meta property="article:author" content="thr">
<meta property="article:tag" content="fabric">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tangsmallrong.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://tangsmallrong.github.io/2023/11/18/Fabric%E5%85%A5%E9%97%A8/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: thr","link":"链接: ","source":"来源: thr's blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Fabric 入门',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-11-18 21:17:22'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="thr's blog"><span class="site-name">thr's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Fabric 入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-18T02:41:20.000Z" title="发表于 2023-11-18 10:41:20">2023-11-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-11-18T13:17:22.240Z" title="更新于 2023-11-18 21:17:22">2023-11-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Blockchain/">Blockchain</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>27分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Fabric 入门"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="Fabric"><a href="#Fabric" class="headerlink" title="Fabric"></a>Fabric</h1><blockquote>
<p>官方文档：<a target="_blank" rel="noopener" href="https://hyperledger-fabric.readthedocs.io/zh-cn/latest/key_concepts.html">关键概念 — hyperledger-fabricdocs master 文档</a></p>
</blockquote>
<h2 id="1-关键概念"><a href="#1-关键概念" class="headerlink" title="1. 关键概念"></a>1. 关键概念</h2><h3 id="1-1-区块链网络"><a href="#1-1-区块链网络" class="headerlink" title="1.1 区块链网络"></a>1.1 区块链网络</h3><p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681270713030.png" alt="1681270713030"></p>
<p>这个 Fabric 区块链网络包括了两个<strong>应用程序通道</strong>以及一个<strong>排序通道</strong>。</p>
<p>组织 R1 和 R4 负责排序通道，R1 和 R2 负责蓝色的应用程序通道，R2 和 R3 负责红色的应用程序通道。</p>
<p>客户端应用程序 A1 是组织 R1 的元素，CA1 是它的<strong>证书颁发机构</strong>。</p>
<p>组织 R2 的节点 P2 可以使用蓝色的通信设施，也可以使用红色的应用程序通道。</p>
<p>每个应用程序通道具有它自己的<strong>通道配置</strong>，这里是 CC1 和 CC2。</p>
<p>系统通道的通道配置是<strong>网络配置</strong> NC4 的一部分。</p>
<blockquote>
<p>一个有四个组织的网络，带有两个通道和三个 Peer 节点，两个智能合约和一个排序服务。</p>
<p>并由四个证书颁发机构来支撑。</p>
<p>它为三个客户端应用程序提供了账本及智能合约服务，这些应用程序可以通过两个通道与账本和智能合约进行交互。</p>
</blockquote>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681271030975.png" alt="1681271030975"></p>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681270977420.png" alt="1681270977420"></p>
<h3 id="1-2-身份"><a href="#1-2-身份" class="headerlink" title="1.2 身份"></a>1.2 身份</h3><ul>
<li>确定了对资源的确切权限以及对参与者在区块链网络中拥有的信息的访问权限</li>
<li>要使身份可以被<strong>验证</strong>，它必须来自<strong>可信任的</strong>权威机构</li>
<li>成员服务提供者（Membership Service Provider，MSP）是 Fabirc 中可以信任的权威机构</li>
<li><strong>MSP 将可验证的身份转变为区块链网络的成员</strong></li>
</ul>
<h4 id="1-2-1-PKI"><a href="#1-2-1-PKI" class="headerlink" title="1.2.1 PKI"></a>1.2.1 PKI</h4><ul>
<li>公钥基础结构（PKI）是一组互联网技术，可在网络中提供安全通信</li>
<li>关键要素<ul>
<li><strong>数字证书</strong></li>
<li><strong>公钥和私钥</strong></li>
<li><strong>证书授权中心</strong></li>
<li><strong>证书撤销列表</strong></li>
</ul>
</li>
</ul>
<h3 id="1-3-成员服务提供者-MSP"><a href="#1-3-成员服务提供者-MSP" class="headerlink" title="1.3 成员服务提供者 (MSP)"></a>1.3 成员服务提供者 (MSP)</h3><blockquote>
<p>以太坊属于匿名网络，hpyerledger 是实名制的网络</p>
</blockquote>
<h3 id="1-4-Peer-节点"><a href="#1-4-Peer-节点" class="headerlink" title="1.4 Peer 节点"></a>1.4 Peer 节点</h3><p>区块链网络主要由 <em>Peer 节点</em>（或者简单称之为 <em>Peer</em>）组成</p>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681285693747.png" alt="1681285693747">区块链网络是由 Peer 节点组成的，每个节点都保存着账本和智能合约的副本。</p>
<p>在这个例子中，网络 N 是由节点 P1、P2 和 P3 组成的，每个节点都维护这他们自己的分布式账本 L1。P1、P2 和 P3 使用相同的链码 S1 来访问他们的分布式账本的副本。</p>
<blockquote>
<p>在 Fabric 中，链码等同于智能合约，因为它们是使用一个被称为<strong>链码</strong>的技术概念来实现<strong>智能合约</strong>的</p>
</blockquote>
<p>Peer 节点是账本及链码的<em>宿主</em>，应用程序及管理员如果想要访问这些资源，他们必须要和 Peer 节点进行交互</p>
<h4 id="1-4-1-多账本"><a href="#1-4-1-多账本" class="headerlink" title="1.4.1 多账本"></a>1.4.1 多账本</h4><ul>
<li>一个 Peer 节点可以维护多个账本，并且每个账本具有零个或者多个链码使用账本</li>
</ul>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681285960829.png" alt="1681285960829"></p>
<p>在这个例子中，我们能够看到 Peer 节点 P1 维护着账本 L1 和 L2。账本 L1 通过链码 S1 来访问。账本 2 通过链码 S1 和 S2 访问</p>
<h4 id="1-4-2-多链码"><a href="#1-4-2-多链码" class="headerlink" title="1.4.2 多链码"></a>1.4.2 多链码</h4><ul>
<li>账本数量和访问账本的链码的数量之间没有固定的关系。一个 Peer 节点可能会有很多链码和账本</li>
</ul>
<h4 id="1-4-3-应用程序和-Peer-节点"><a href="#1-4-3-应用程序和-Peer-节点" class="headerlink" title="1.4.3 应用程序和 Peer 节点"></a>1.4.3 应用程序和 Peer 节点</h4><p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681287048342.png" alt="1681287048342"></p>
<h4 id="1-4-4-Peer-节点和排序节点"><a href="#1-4-4-Peer-节点和排序节点" class="headerlink" title="1.4.4 Peer 节点和排序节点"></a>1.4.4 Peer 节点和排序节点</h4><ul>
<li><p><strong>一个更新的交易和一个查询的交易区别很大</strong>，因为一个单独的 Peer 节点不能够由它自己来更新账本——<strong>更新需要网络中其他节点的同意</strong></p>
</li>
<li><p>在一个账本的更新被应用到 Peer 节点的本地账本之前， Peer 节点会请求网络中的其他 Peer 节点来批准这次更新。这个过程被称为<strong>共识</strong>，这会比一个简单的查询花费更长的时间来完成</p>
</li>
<li><p>想要更新账本的应用程序会被引入到一个三阶段的流程，这确保了在一个区块链网络中所有的 Peer 节点都彼此保持着一致的账本。</p>
<ul>
<li>在第一个阶段，应用程序会跟<em>背书节点</em>的子集一起工作，其中的每个节点都会向应用程序为提案的账本更新提供背书，但是不会将提案的更新应用到他们的账本副本上。</li>
<li>在第二个阶段，这些分散的背书会被搜集到一起当做交易被打包进区块中。</li>
<li>在最后一个阶段，这些区块会被分发回每个 Peer 节点，在这些 Peer 节点上每笔交易在被应用到 Peer 节点的账本副本之前会被验证。</li>
</ul>
<blockquote>
<p>排序节点在这个流程中处于中心地位</p>
</blockquote>
</li>
</ul>
<h3 id="1-5-chaincode-智能合约"><a href="#1-5-chaincode-智能合约" class="headerlink" title="1.5 chaincode 智能合约"></a>1.5 chaincode 智能合约</h3><ul>
<li>智能合约用可执行的代码定义了不同组织之间的规则。应用程序调用智能合约来生成被记录到账本上的交易。</li>
</ul>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681294843518.png" alt="1681294843518"></p>
<blockquote>
<p>在上图中，我们可以看到组织 <code>ORG1</code> 和 <code>ORG2</code> 是如何通过定义一个 <code>car</code> 智能合约来实现 <code>查询</code>、<code>转移</code> 和 <code>更新</code> 汽车的。来自这些组织的应用程序调用此智能合约执行业务流程中已商定的步骤，例如将特定汽车的所有权从 <code>ORG1</code> 转移到 <code>ORG2</code></p>
</blockquote>
<p>可以将智能合约看成交易的管理者，而链码则管理着如何将智能合约打包以便用于部署。</p>
<p>一个智能合约定义在一个链码中。而多个智能合约也可以定义在同一个链码中。当一个链码部署完毕，该链码中的所有智能合约都可供应用程序使用。</p>
<ul>
<li>智能合约的核心是一组 <code>交易</code> 定义。例如，在 <code>fabcar.js</code>中，你可以看到一个创建了一辆新车的智能合约交易：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">createCar</span>(<span class="params">ctx, carNumber, make, model, color, owner</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> car = &#123;</span><br><span class="line">        color,</span><br><span class="line">        <span class="attr">docType</span>: <span class="string">&#x27;car&#x27;</span>,</span><br><span class="line">        make,</span><br><span class="line">        model,</span><br><span class="line">        owner,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="property">stub</span>.<span class="title function_">putState</span>(carNumber, <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(car)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-5-1-背书"><a href="#1-5-1-背书" class="headerlink" title="1.5.1 背书"></a>1.5.1 背书</h4><ul>
<li>每个链码都有一个<strong>背书</strong>策略与之相关联，该背书策略适用于此链码中定义的所有智能合约。背书策略非常重要，它指明了区块链网络中<strong>哪些组织必须对一个给定的智能合约所生成的交易进行签名</strong>，以此来宣布该交易<strong>有效</strong>。<ul>
<li>一个示例背书策略可能这样定义：参与区块链网络的四个组织中有三个必须在交易被认为<strong>有效</strong>之前签署该交易。所有的交易，无论是<strong>有效的</strong>还是<strong>无效的</strong>，都会被添加到分布式账本中，但只有<strong>有效</strong>交易会更新世界状态。</li>
<li>背书策略是 Hyperledger Fabric 与以太坊（Ethereum）或比特币（Bitcoin）等其他区块链的区别所在</li>
</ul>
</li>
</ul>
<h4 id="1-5-2-有效交易"><a href="#1-5-2-有效交易" class="headerlink" title="1.5.2 有效交易"></a>1.5.2 有效交易</h4><p>注意，在执行智能合约时<strong>世界状态没有更新</strong>！</p>
<ul>
<li><p>所有的交易都有一个识别符、一个提案和一个被一群组织签名的响应。所有交易，无论是否有效，都会被记录在区块链上，但<strong>仅有效交易会更新世界状态</strong>。</p>
</li>
<li><p>有效交易举例：</p>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681296263304.png" alt="1681296263304"></p>
<blockquote>
<p>检查 <code>车辆转移</code> 交易。您可以看到 <code>ORG1</code> 和 <code>ORG2</code> 之间为转移一辆车而进行的交易 <code>t3</code>。看一下交易是如何通过输入 <code>&#123;CAR1，ORG1，ORG2&#125;</code> 和输出 <code>&#123;CAR1.owner=ORG1，CAR1.owner=ORG2&#125;</code> 来表示汽车的所有者从 <code>ORG1</code> 变为了 <code>ORG2</code>。注意输入是如何由应用程序的组织 <code>ORG1</code> 签名的，输出是如何由背书策略标识的<em>两个</em>组织（ <code>ORG1</code> 和 <code>ORG2</code> ）签名的。这些签名是使用每个参与者的私钥生成的，这意味着网络中的任何人都可以验证网络中的所有参与者是否在交易细节上达成了一致</p>
</blockquote>
</li>
<li><p>一项交易被分发给网络中的所有节点，各节点通过两个阶段对其进行<strong>验证</strong>。首先，根据背书策略检查交易，确保该交易已被足够的组织签署。其次，继续检查交易，以确保当该交易在受到背书节点签名时它的交易读集与世界状态的当前值匹配，并且中间过程中没有被更新。如果一个交易通过了这两个测试，它就被标记为<strong>有效</strong>。所有交易，不管是<strong>有效的</strong>还是<strong>无效的</strong>，都会被添加到区块链历史中，但是仅<strong>有效的</strong>交易才会更新世界状态。</p>
</li>
</ul>
<h4 id="1-5-3-通道"><a href="#1-5-3-通道" class="headerlink" title="1.5.3 通道"></a>1.5.3 通道</h4><ul>
<li>Hyperledger Fabric 允许一个组织利用<strong>通道</strong>同时参与多个、彼此独立的区块链网络。通过加入多个通道，一个组织可以参与一个所谓的<strong>网络的网络</strong></li>
<li>通道在一群组织之间提供了一种完全独立的通信机制。当链码定义被提交到通道上时，该通道上所有的应用程序都可以使用此链码中的智能合约。</li>
</ul>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681296849809.png" alt="1681296849809"></p>
<blockquote>
<p>在上面的示例中，<code>car</code> 智能合约被定义在 <code>VEHICLE</code> 通道上，<code>insurance</code> 智能合约被定义在 <code>INSURANCE</code> 通道上。<code>car</code> 的链码定义明确了以下背书策略：任何交易在被认定为有效之前必须由 <code>ORG1</code> 和 <code>ORG2</code> 共同签名。<code>insurance</code> 智能合约的链码定义明确了只需要 <code>ORG3</code> 对交易进行背书即可。<code>ORG1</code> 参与了 <code>VEHICLE</code> 通道和 <code>INSURANCE</code> 通道这两个网络，并且能够跨网络协调与 <code>ORG2</code> 和 <code>ORG3</code> 的活动。</p>
</blockquote>
<h3 id="1-6-账本"><a href="#1-6-账本" class="headerlink" title="1.6 账本"></a>1.6 账本</h3><ul>
<li>由“世界状态“和”区块链“这两部分组成<ul>
<li><strong>世界状态</strong>是一个数据库，它存储了一组账本状态的<strong>当前值</strong>，通过世界状态，程序可以直接访问一个账本状态的当前值，不需要遍历整个交易日志来计算当前值</li>
<li><strong>区块链</strong>是交易日志，它记录了促成当前世界状态的所有改变</li>
</ul>
</li>
</ul>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681301669101.png" alt="1681301669101"></p>
<blockquote>
<p>账本 L 由区块链 B 和世界状态 W 组成，其中世界状态 W 由区块链 B 决定。我们也可以说世界状态 W 是源自区块链 B</p>
</blockquote>
<h4 id="1-6-1-世界状态"><a href="#1-6-1-世界状态" class="headerlink" title="1.6.1 世界状态"></a>1.6.1 世界状态</h4><ul>
<li><strong>世界状态被作为数据库来实现</strong></li>
</ul>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681301818989.png" alt="1681301818989"></p>
<blockquote>
<p>示例展示的是 CAR1 和 CAR2 这两辆车的账本状态，二者都各有一个值和一个键。应用程序可以调用智能合约，该合约使用简单的账本 API 来<strong>获取</strong>、<strong>写入</strong>和<strong>删除</strong>状态。注意状态值可以是简单值（Audi…），也可以是复合值（type:BMW…）。经常会通过查询世界状态来检索具有某些特定属性的对象，例如查找所有红色宝马汽车。</p>
</blockquote>
<ul>
<li>应用程序提交那些会更改世界状态的交易，这些交易最终被提交到账本区块链上。</li>
<li>应用程序无法看到 Hyperledger Fabric SDK（软件开发工具包）设定的共识机制的细节内容，它们能做的只是调用智能合约以及在交易被收进区块链时收到通知（<strong>所有被提交的交易，无论有效与否，都会被收进区块链</strong>），但是只有那些受到相关<strong>背书组织签名</strong>的交易才会更新世界状态。如果一个交易没有得到足够背书节点的签名，那么它不会更新世界状态</li>
<li>每个状态都有一个版本号，版本号是供 Hyperledger Fabric 内部使用的，并且每次状态更改时版本号会发生递增。每当更新状态时，都会检查该状态的版本，以确保当前状态与背书时的版本相匹配。</li>
</ul>
<h4 id="1-6-2-区块链"><a href="#1-6-2-区块链" class="headerlink" title="1.6.2 区块链"></a>1.6.2 区块链</h4><ul>
<li><strong>世界状态</strong>存储了与业务对象<strong>当前状态</strong>相关的事实信息</li>
<li>而<strong>区块链</strong>是一种<strong>历史记录</strong>，它记录了这些业务对象是如何到达各自当前状态的相关事实。区块链记录了每个账本状态之前的所有版本以及状态是如何被更改的</li>
<li>区块链的结构是一群相互链接的区块的序列化日志，其中每个区块都包含一系列交易，各项交易代表了一个对世界状态进行的查询或更新操作</li>
<li>&#x3D;&#x3D;区块链总是以文件实现，而与之相反的是，世界状态以数据库实现&#x3D;&#x3D;</li>
</ul>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681302297465.png" alt="1681302297465"></p>
<blockquote>
<p>B0 是该区块链的第一个区块，也叫创世区块</p>
<p>它并不包含任何用户交易，但却是账本的起始点</p>
<p>相反的，创世区块包含了一个配置交易，该交易含有网络配置（未显示）的初始状态</p>
</blockquote>
<h4 id="1-6-3-区块"><a href="#1-6-3-区块" class="headerlink" title="1.6.3 区块"></a>1.6.3 区块</h4><p>组成</p>
<ul>
<li><p><strong>区块头</strong></p>
<ul>
<li><strong>区块编号</strong>：编号从0（初始区块）开始，每在区块链上增加一个新区块，编号的数字都会加1。</li>
<li><strong>当前区块的哈希值</strong>：当前区块中包含的所有交易的哈希值。</li>
<li><strong>前一个区块头的哈希值</strong>：区块链中前一个区块头的哈希值。</li>
</ul>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681302542402.png" alt="1681302542402"></p>
<blockquote>
<p><em>区块头详情：区块 B2 的区块头 H2 包含了区块编号 2，当前区块数据 D2 的哈希值 CH2，以及前一个区块头 H1 的哈希值。</em></p>
</blockquote>
</li>
<li><p><strong>区块数据</strong></p>
<ul>
<li>这部分包含了一个<strong>有序的交易列表</strong>。区块数据是在排序服务创建区块时被写入的</li>
</ul>
</li>
<li><p><strong>区块元数据</strong></p>
<ul>
<li>这个部分包含了区块被写入的时间，还有区块写入者的证书、公钥以及签名。随后，区块的提交者也会为每一笔交易添加一个有效或无效的标记，但由于这一信息与区块同时产生，所以它不会被包含在哈希中。</li>
</ul>
</li>
</ul>
<h4 id="1-6-4-交易"><a href="#1-6-4-交易" class="headerlink" title="1.6.4 交易"></a>1.6.4 交易</h4><ul>
<li>交易记录了世界状态发生的更新</li>
<li>把交易包含在区块中的<strong>区块数据</strong>结构</li>
</ul>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681303391932.png" alt="1681303391932"></p>
<blockquote>
<p><em>交易详情：交易 T4 位于区块 B1 的区块数据 D1 中，T4包括的内容如下：交易头 H4，一个交易签名 S4，一个交易提案 P4，一个交易响应 R4 和一系列背书 E4。</em></p>
<p><strong>头</strong></p>
<p>这部分用 H4 表示，它记录了关于交易的一些重要元数据，比如，相关链码的名字以及版本。</p>
<p><strong>签名</strong></p>
<p>这部分用 S4 表示，它包含了一个由客户端应用程序创建的加密签名。该字段是用来检查交易细节是否未经篡改，<strong>因为交易签名的生成需要用到应用程序的私钥。</strong></p>
<p><strong>提案</strong></p>
<p>这部分用 P4 表示，它负责对应用程序供给智能合约的输入参数进行编码，随后该智能合约生成提案账本更新。在智能合约运行时，这个提案提供了一套输入参数，这些参数同当前的世界状态一起决定了新的账本世界状态。</p>
<p><strong>响应</strong></p>
<p>这部分用 R4 表示，它是以<strong>读写集</strong> （RW-set）的形式记录下世界状态之前和之后的值。交易响应是智能合约的输出，如果交易验证成功，那么该交易会被应用到账本上，从而更新世界状态。</p>
<p><strong>背书</strong></p>
</blockquote>
<ul>
<li><p>示例账本</p>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681304156885.png" alt="1681304156885"></p>
<blockquote>
<p>账本 L包含了一个世界状态 W 和一个区块链 B。其中 W 包含了四个状态，各状态的键分别是：CAR0，CAR1，CAR2 和 CAR3 。而 B 包含了两个区块 0和 1。区块1包含了四笔交易：T1，T2，T3，T4</p>
</blockquote>
</li>
</ul>
<h3 id="1-7-排序服务"><a href="#1-7-排序服务" class="headerlink" title="1.7 排序服务"></a>1.7 排序服务</h3><ul>
<li>Hyperledger Fabric 的工作方式不同。它有一种称为<strong>排序节点</strong>的节点使交易有序，并与其他排序节点一起形成一个<strong>排序服务</strong>。因为 Fabric 的设计依赖于<strong>确定性</strong>的共识算法，所以 Peer 节点所验证的区块都是最终的和正确的。账本不会像其他分布式的以及无需许可的区块链中那样产生分叉</li>
<li>排序节点还维护着允许创建通道的组织列表。此组织列表称为“联盟”</li>
<li>排序节点还对通道执行基本访问控制，限制谁可以读写数据，以及谁可以配置数据</li>
</ul>
<h4 id="1-7-1-排序节点和交易流程"><a href="#1-7-1-排序节点和交易流程" class="headerlink" title="1.7.1 排序节点和交易流程"></a>1.7.1 排序节点和交易流程</h4><blockquote>
<p><strong>更新账本的应用程序涉及到三个阶段</strong>，该过程确保区块链网络中的所有节点保持它们的账本彼此一致。</p>
<p>在第一阶段，客户端应用程序将交易提案发送给一组节点，这些节点将调用智能合约来生成一个账本更新提案，然后背书该结果。背书节点此时不将提案中的更新应用于其账本副本。相反，背书节点将向客户端应用程序返回一个提案响应。</p>
<p>已背书的交易提案最终将在第二阶段经过排序生成区块，</p>
<p>然后在第三阶段分发给所有节点进行最终验证和提交。</p>
</blockquote>
<ul>
<li>将交易排序并打包到区块中<ul>
<li>在此阶段，应用程序客户端把包含已背书交易提案响应的交易提交到排序服务节点。排序服务创建交易区块，这些交易区块最终将分发给通道上的所有 Peer 节点，以便在第三阶段进行最终验证和提交。</li>
<li>排序服务节点的工作是将提交的交易按定义好的顺序安排成批次，并将它们打包成<em>区块</em>。这些区块将成为区块链的<em>区块</em>！</li>
</ul>
</li>
</ul>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681360371573.png" alt="1681360371573"></p>
<blockquote>
<p><em>排序节点的第一个角色是打包提案的账本更新。在本例中，应用程序 A1 向排序节点 O1 发送由 E1 和 E2 背书的交易 T1。同时，应用程序 A2 将 E1 背书的交易 T2 发送给排序节点 O1。O1 将来自应用程序 A1 的交易 T1 和来自应用程序 A2 的交易 T2 以及来自网络中其他应用程序的交易打包到区块 B2 中。我们可以看到，在 B2 中，交易顺序是 T1、T2、T3、T4、T6、T5，但这可能不是这些交易到达排序节点的顺序！（这个例子显示了一个非常简单的排序服务配置，只有一个排序节点。）</em></p>
</blockquote>
<ul>
<li>验证和提交</li>
</ul>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681360785332.png" alt="1681360785332"></p>
<blockquote>
<p><em>排序节点的第二个角色是将区块分发给 Peer 节点。在本例中，排序节点 O1 将区块 B2 分配给节点 P1 和 P2。节点 P1 处理区块 B2，在 P1 上的账本 L1 中添加一个新区块。同时，节点 P2 处理区块 B2，从而将一个新区块添加到 P2 上的账本 L1中。一旦这个过程完成，节点 P1 和 P2 上的账本 L1 就会保持一致的更新，并且每个节点都可以通知与之连接的应用程序交易已经被处理。</em></p>
</blockquote>
<h4 id="1-7-2-排序服务的实现"><a href="#1-7-2-排序服务的实现" class="headerlink" title="1.7.2 排序服务的实现"></a>1.7.2 排序服务的实现</h4><ul>
<li>推荐 <strong>Raft</strong><ul>
<li>Raft 是一种基于 <code>etcd</code>中 Raft 协议实现的崩溃容错（Crash Fault Tolerant，CFT）排序服务。Raft 遵循“领导者跟随者”模型，这个模型中，在每个通道上选举领导者节点，其决策被跟随者复制。Raft 排序服务会比基于 Kafka 的排序服务更容易设置和管理，它的设计允许不同的组织为分布式排序服务贡献节点。</li>
<li>节点总是处于以下三种状态之一：跟随者、候选人或领导者。所有节点最初都是作为<strong>跟随者</strong>开始的。在这种状态下，他们可以接受来自领导者的日志条目（如果其中一个已经当选），或者为领导者投票。如果在一段时间内没有接收到日志条目或心跳（例如，5秒），节点将自己提升到<strong>候选</strong>状态。在候选状态中，节点从其他节点请求选票。如果候选人获得法定人数的选票，那么他就被提升为领导者。领导者必须接受新的日志条目并将其复制到跟随者。</li>
</ul>
</li>
</ul>
<h2 id="2-入门"><a href="#2-入门" class="headerlink" title="2. 入门"></a>2. 入门</h2><h3 id="2-1-配置环境"><a href="#2-1-配置环境" class="headerlink" title="2.1 配置环境"></a>2.1 配置环境</h3><blockquote>
<p>此处参考b站视频，虽然可能不全，并且后半段实现不了</p>
<p>但是前面的跟下来都还不错！但是要注意自己的版本问题！</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1g3411h71Z/?spm_id_from=333.337.search-card.all.click&vd_source=ce97d263f08af76fc25ff49de530fe92">从0开始快速安装Hyperledger Fabric_哔哩哔哩_bilibili</a></p>
</blockquote>
<h4 id="2-1-1-ubuntu-联网"><a href="#2-1-1-ubuntu-联网" class="headerlink" title="2.1.1 ubuntu 联网"></a>2.1.1 ubuntu 联网</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart NetworkManager.service</span><br><span class="line">sudo apt-get install network-manager</span><br><span class="line">sudo systemctl restart NetworkManager.service</span><br></pre></td></tr></table></figure>

<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681387612411.png" alt="1681387612411"></p>
<h4 id="2-1-2-apt-换源"><a href="#2-1-2-apt-换源" class="headerlink" title="2.1.2 apt 换源"></a>2.1.2 apt 换源</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/</span><br><span class="line">sudo gedit /etc/apt/sources.list</span><br><span class="line">sudo apt update</span><br></pre></td></tr></table></figure>

<h4 id="2-1-3-安装-docker"><a href="#2-1-3-安装-docker" class="headerlink" title="2.1.3 安装 docker"></a>2.1.3 安装 docker</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 安装docker、docker-compose</span><br><span class="line">sudo apt install docker docker-compose</span><br><span class="line">sudo systemctl enable docker</span><br><span class="line">sudo usermod -a -G docker &lt;username&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-1-4-安装-golang"><a href="#2-1-4-安装-golang" class="headerlink" title="2.1.4 安装 golang"></a>2.1.4 安装 golang</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 安装golang</span><br><span class="line">https://go.dev/doc/install</span><br><span class="line">sudo su</span><br><span class="line">rm -rf /usr/local/go &amp;&amp; tar -C /usr/local -xzf go1.17.6.linux-amd64.tar.gz</span><br><span class="line">gedit /etc/profile</span><br><span class="line">	export PATH=$PATH:/usr/local/go/bin</span><br><span class="line">gedit ~/.bashrc</span><br><span class="line">	source /etc/profile</span><br></pre></td></tr></table></figure>

<h4 id="2-1-5-docker-加速器"><a href="#2-1-5-docker-加速器" class="headerlink" title="2.1.5 docker 加速器"></a>2.1.5 docker 加速器</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// docker加速器</span><br><span class="line">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</span><br></pre></td></tr></table></figure>

<h4 id="2-1-6-安装fabric-sample"><a href="#2-1-6-安装fabric-sample" class="headerlink" title="2.1.6 安装fabric-sample"></a>2.1.6 安装fabric-sample</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1、手动创建脚本，安装samples、docker</span><br><span class="line">https://github.com/hyperledger/fabric/blob/main/scripts/bootstrap.sh</span><br><span class="line">修改binaries=false</span><br><span class="line">sudo chmod u+x bootstrap.sh</span><br><span class="line">./bootstrap.sh</span><br><span class="line"></span><br><span class="line">2、安装binaries</span><br><span class="line">https://github.com/hyperledger/fabric/releases/download/v2.4.1/hyperledger-fabric-linux-amd64-2.4.1.tar.gz</span><br><span class="line">https://github.com/hyperledger/fabric-ca/releases/download/v1.5.2/hyperledger-fabric-ca-linux-amd64-1.5.2.tar.gz</span><br><span class="line">tar -xzvf 压缩包名 -C 目的地</span><br><span class="line"></span><br><span class="line">3、配置go代理</span><br><span class="line">go env -w GO111MODULE=on</span><br><span class="line">go env -w GOPROXY=https://goproxy.cn,direct</span><br></pre></td></tr></table></figure>

<h2 id="3-开发"><a href="#3-开发" class="headerlink" title="3. 开发"></a>3. 开发</h2><h3 id="3-1-分析"><a href="#3-1-分析" class="headerlink" title="3.1 分析"></a>3.1 分析</h3><h4 id="3-1-1-商业票据"><a href="#3-1-1-商业票据" class="headerlink" title="3.1.1 商业票据"></a>3.1.1 商业票据</h4><ul>
<li><p>票据 00001 是 5 月 31 号由 MagnetoCorp 发行的。该票据的第一个<strong>状态</strong>，它具有不同的属性和值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Issuer = MagnetoCorp</span><br><span class="line">Paper = 00001</span><br><span class="line">Owner = MagnetoCorp</span><br><span class="line">Issue date = 31 May 2020</span><br><span class="line">Maturity = 30 November 2020</span><br><span class="line">Face value = 5M USD</span><br><span class="line">Current state = issued</span><br></pre></td></tr></table></figure>

<blockquote>
<p>票据的状态是 <strong>发行</strong> 交易的结果，它使得 MagnetoCorp 公司的第一张商业票据面世！注意该票据在今年晚些时候如何兑换面值 500 万美元。当票据 00001 发行后 <code>Issuer</code> 和 <code>Owner</code> 具有相同的值。该票据有唯一标识 <code>MagnetoCorp00001</code>——它是 <code>Issuer</code> 属性和 <code>Paper</code> 属性的组合。最后，属性 <code>Current state = issued</code> 快速识别了 MagnetoCorp 票据 00001 在它生命周期中的阶段。</p>
</blockquote>
</li>
<li><p>发行后不久，该票据被 DigiBank 购买。由于<strong>购买</strong>交易，同一个商业票据如何发生变化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Issuer = MagnetoCorp</span><br><span class="line">Paper = 00001</span><br><span class="line">Owner = DigiBank</span><br><span class="line">Issue date = 31 May 2020</span><br><span class="line">Maturity date = 30 November 2020</span><br><span class="line">Face value = 5M USD</span><br><span class="line">Current state = trading</span><br></pre></td></tr></table></figure>

<blockquote>
<p>最重要的变化是 <code>Owner</code> 的改变——票据初始拥有者是 <code>MagnetoCorp</code> 而现在是 <code>DigiBank</code>。我们可以想象该票据后来如何被出售给 BrokerHouse 或 HedgeMatic，以及相应的变更为相应的 <code>Owner</code>。注意 <code>Current state</code> 允许我们轻松的识别该票据目前状态是 <code>trading</code>。</p>
</blockquote>
</li>
<li><p>6 个月后，如果 DigiBank 仍然持有商业票据，它就可以从 MagnetoCorp 那里兑换：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Issuer = MagnetoCorp</span><br><span class="line">Paper = 00001</span><br><span class="line">Owner = MagnetoCorp</span><br><span class="line">Issue date = 31 May 2020</span><br><span class="line">Maturity date = 30 November 2020</span><br><span class="line">Face value = 5M USD</span><br><span class="line">Current state = redeemed</span><br></pre></td></tr></table></figure>

<blockquote>
<p>最终的<strong>兑换</strong>交易结束了这个商业票据的生命周期——它可以被认为票据已经终止。通常必须保留已兑换的商业票据的记录，并且 <code>redeemed</code> 状态允许我们快速识别这些。通过将 <code>Owner</code> 跟交易创建者的身份进行比较，一个票据的 <code>Owner</code> 值可以被用来在<strong>兑换</strong>交易上进行访问控制</p>
</blockquote>
</li>
</ul>
<h4 id="3-1-2-交易"><a href="#3-1-2-交易" class="headerlink" title="3.1.2 交易"></a>3.1.2 交易</h4><ul>
<li><p>我们已经看到票据 00001 的生命周期相对简单——由于<strong>发行</strong>，<strong>购买</strong>和<strong>兑换</strong>交易，它在 <code>issued</code>, <code>trading</code> 和 <code>redeemed</code> 状态之间转移</p>
</li>
<li><p>注意交易和票据不同！！</p>
<ul>
<li>发行交易</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Txn = issue</span><br><span class="line">Issuer = MagnetoCorp</span><br><span class="line">Paper = 00001</span><br><span class="line">Issue time = 31 May 2020 09:00:00 EST</span><br><span class="line">Maturity date = 30 November 2020</span><br><span class="line">Face value = 5M USD</span><br></pre></td></tr></table></figure>

<ul>
<li>购买交易</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Txn = buy</span><br><span class="line">Issuer = MagnetoCorp</span><br><span class="line">Paper = 00001</span><br><span class="line">Current owner = MagnetoCorp</span><br><span class="line">New owner = DigiBank</span><br><span class="line">Purchase time = 31 May 2020 10:00:00 EST</span><br><span class="line">Price = 4.94M USD</span><br></pre></td></tr></table></figure>

<ul>
<li>兑换交易</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Txn = redeem</span><br><span class="line">Issuer = MagnetoCorp</span><br><span class="line">Paper = 00001</span><br><span class="line">Current owner = HedgeMatic</span><br><span class="line">Redeem time = 30 Nov 2020 12:00:00 EST</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="3-2-流程和数据设计"><a href="#3-2-流程和数据设计" class="headerlink" title="3.2 流程和数据设计"></a>3.2 流程和数据设计</h3><h4 id="3-2-1-生命周期"><a href="#3-2-1-生命周期" class="headerlink" title="3.2.1 生命周期"></a>3.2.1 生命周期</h4><ul>
<li><p>在处理商业票据时有两个重要的概念：<strong>状态</strong>和<strong>交易</strong></p>
</li>
<li><p>对状态和交易的有效分析是成功实施的重要起点，可以用状态转移表来表示商业票据的生命周期：</p>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681607417562.png" alt="1681607417562"></p>
<blockquote>
<p><em>商业票据的状态转移表。商业票据通过<strong>发行</strong>，<strong>购买</strong>和<strong>兑换</strong>交易在<strong>已发行</strong>、<strong>交易中</strong>和<strong>已兑换</strong>之间进行状态转移。</em></p>
</blockquote>
</li>
</ul>
<h4 id="3-2-2-账本状态"><a href="#3-2-2-账本状态" class="headerlink" title="3.2.2 账本状态"></a>3.2.2 账本状态</h4><ul>
<li><p>商业票据的结构：</p>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681607716814.png" alt="1681607716814"></p>
<blockquote>
<p><em>商业票据可以被表示为属性集，每个属性都对应一个值。通常，这些属性的组合会为每个票据提供一个唯一键</em></p>
<p>结合来看，属性的完整集合构成了商业票据的<strong>状态</strong>。此外，这些商业票据的全部集合构成了账本的世界状态。</p>
</blockquote>
</li>
<li><p>查看 MagnetoCorp 的票据 <code>00001</code> 如何表示为一个状态向量，根据不同的交易刺激进行转换:</p>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681607900927.png" alt="1681607900927"></p>
<blockquote>
<p>注意每个独立的票据都起于空状态，技术上被称作 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Null_(SQL)">nil</a>，来表示票据不存在！通过<strong>发行</strong>交易，票据 <code>00001</code> 问世，然后由于<strong>购买</strong>和<strong>兑换</strong>交易而更新状态</p>
</blockquote>
</li>
</ul>
<h4 id="3-2-3-状态键值"><a href="#3-2-3-状态键值" class="headerlink" title="3.2.3 状态键值"></a>3.2.3 状态键值</h4><ul>
<li>大多数的实际应用中，状态会有一个属性组合在给定的上下文中唯一识别它——它就是<strong>主键</strong></li>
<li>PaperNet 商业票据的主键是通过 <code>Issuer</code> 属性和 <code>paper</code> 属性拼接得到的，所以 MagnetoCorp 的第一个票据的主键就是 <code>MagnetoCorp00001</code></li>
<li>Fabric 需要账本中的每个状态都有唯一的主键</li>
<li>当唯一主键在可用的属性集中不能获得，应用决定的唯一键会被指定为交易的输入来创建状态。<strong>这个唯一键的形式一般是 UUID</strong></li>
</ul>
<h4 id="3-2-3-逻辑表示"><a href="#3-2-3-逻辑表示" class="headerlink" title="3.2.3 逻辑表示"></a>3.2.3 逻辑表示</h4><blockquote>
<p>为了满足不同类型的查询任务，把所有相关的商业票据按逻辑顺序排列在一起是很有帮助的。PaperNet 的设计包含了商业票据列表的思想——一个逻辑容器，每当商业票据发行或发生其他更改时，该容器都会更新</p>
</blockquote>
<ul>
<li><p>把所有的 PaperNet 商业票据放在一个商业票据列表中是有帮助的：</p>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681608349698.png" alt="1681608349698"></p>
<blockquote>
<p>新票据由于<strong>发行</strong>交易被加入到列表中，然后列表中已存在的票据因为<strong>购买</strong>交易和<strong>兑换</strong>交易可以被更新状态。列表有一个描述性的名称：<code>org.papernet.papers</code>；使用这种DNS 名真的是一个好主意，因为适当的名称会让你的区块链设计对其他人来说是直观的。这种想法同样也适用于智能合约的名字。</p>
</blockquote>
</li>
</ul>
<h4 id="3-2-4-物理表现"><a href="#3-2-4-物理表现" class="headerlink" title="3.2.4 物理表现"></a>3.2.4 物理表现</h4><ul>
<li><p>我们可以正确地想到 PaperNet 中的单个票据列表—— <code>org.papernet.papers</code> ——列表最好作为一组单独的 Fabric 状态来实现，其复合键将状态与其列表关联起来。这样，每个状态的复合键都是惟一的，并支持有效的列表查询</p>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681608524162.png" alt="1681608524162"></p>
</li>
<li><p>状态向量的物理设计对于优化性能和行为<strong>非常重要</strong>。保持状态的独立！</p>
</li>
</ul>
<h3 id="3-3-智能合约处理"><a href="#3-3-智能合约处理" class="headerlink" title="3.3 智能合约处理"></a>3.3 智能合约处理</h3><blockquote>
<p> 连接到网络的所有应用程序必须使用相同版本的智能合约，以便它们共同实现相同的共享业务流程和数据。</p>
</blockquote>
<blockquote>
<p>在 Java 中，类必须使用 <code>@Contract(...)</code> 标注进行包装。它支持额外的智能合约信息，比如许可和作者。 <code>@Default()</code> 标注表明该智能合约是默认合约类。在智能合约中标记默认合约类在一些有多个合约类的智能合约中会很有用。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/hyperledger/fabric-samples/blob/master/commercial-paper/organization/magnetocorp//contract-java/src/main/java/org/example/CommercialPaperContract.java">fabric-samples&#x2F;CommercialPaperContract.java at master · hyperledger&#x2F;fabric-samples (github.com)</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.ledgerapi.State;</span><br><span class="line"><span class="keyword">import</span> org.hyperledger.fabric.contract.Context;</span><br><span class="line"><span class="keyword">import</span> org.hyperledger.fabric.contract.ContractInterface;</span><br><span class="line"><span class="keyword">import</span> org.hyperledger.fabric.contract.annotation.Contact;</span><br><span class="line"><span class="keyword">import</span> org.hyperledger.fabric.contract.annotation.Contract;</span><br><span class="line"><span class="keyword">import</span> org.hyperledger.fabric.contract.annotation.Default;</span><br><span class="line"><span class="keyword">import</span> org.hyperledger.fabric.contract.annotation.Info;</span><br><span class="line"><span class="keyword">import</span> org.hyperledger.fabric.contract.annotation.License;</span><br><span class="line"><span class="keyword">import</span> org.hyperledger.fabric.contract.annotation.Transaction;</span><br><span class="line"><span class="keyword">import</span> org.hyperledger.fabric.shim.ChaincodeStub;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A custom context provides easy access to list of all commercial papers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define commercial paper smart contract by extending Fabric Contract class</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Contract(name = &quot;org.papernet.commercialpaper&quot;, info = @Info(title = &quot;MyAsset contract&quot;, description = &quot;&quot;, version = &quot;0.0.1&quot;, license = @License(name = &quot;SPDX-License-Identifier: Apache-2.0&quot;, url = &quot;&quot;), contact = @Contact(email = &quot;java-contract@example.com&quot;, name = &quot;java-contract&quot;, url = &quot;http://java-contract.me&quot;)))</span></span><br><span class="line"><span class="meta">@Default</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommercialPaperContract</span> <span class="keyword">implements</span> <span class="title class_">ContractInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use the classname for the logger, this way you can refactor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> Logger.getLogger(CommercialPaperContract.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Context <span class="title function_">createContext</span><span class="params">(ChaincodeStub stub)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommercialPaperContext</span>(stub);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommercialPaperContract</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Define a custom context for commercial paper</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Instantiate to perform any setup of the ledger that might be required.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;Context&#125; ctx the transaction context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transaction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">instantiate</span><span class="params">(CommercialPaperContext ctx)</span> &#123;</span><br><span class="line">        <span class="comment">// No implementation required with this example</span></span><br><span class="line">        <span class="comment">// It could be where data migration is performed, if necessary</span></span><br><span class="line">        LOG.info(<span class="string">&quot;No data migration to perform&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Issue commercial paper</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;Context&#125; ctx the transaction context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;String&#125; issuer commercial paper issuer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;Integer&#125; paperNumber paper number for this issuer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;String&#125; issueDateTime paper issue date</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;String&#125; maturityDateTime paper maturity date</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;Integer&#125; faceValue face value of paper</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transaction</span></span><br><span class="line">    <span class="keyword">public</span> CommercialPaper <span class="title function_">issue</span><span class="params">(CommercialPaperContext ctx, String issuer, String paperNumber, String issueDateTime,</span></span><br><span class="line"><span class="params">            String maturityDateTime, <span class="type">int</span> faceValue)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(ctx);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create an instance of the paper</span></span><br><span class="line">        <span class="type">CommercialPaper</span> <span class="variable">paper</span> <span class="operator">=</span> CommercialPaper.createInstance(issuer, paperNumber, issueDateTime, maturityDateTime,</span><br><span class="line">                faceValue,issuer,<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Smart contract, rather than paper, moves paper into ISSUED state</span></span><br><span class="line">        paper.setIssued();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Newly issued paper is owned by the issuer</span></span><br><span class="line">        paper.setOwner(issuer);</span><br><span class="line"></span><br><span class="line">        System.out.println(paper);</span><br><span class="line">        <span class="comment">// Add the paper to the list of all similar commercial papers in the ledger</span></span><br><span class="line">        <span class="comment">// world state</span></span><br><span class="line">        ctx.paperList.addPaper(paper);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Must return a serialized paper to caller of smart contract</span></span><br><span class="line">        <span class="keyword">return</span> paper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Buy commercial paper</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;Context&#125; ctx the transaction context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;String&#125; issuer commercial paper issuer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;Integer&#125; paperNumber paper number for this issuer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;String&#125; currentOwner current owner of paper</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;String&#125; newOwner new owner of paper</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;Integer&#125; price price paid for this paper</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;String&#125; purchaseDateTime time paper was purchased (i.e. traded)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transaction</span></span><br><span class="line">    <span class="keyword">public</span> CommercialPaper <span class="title function_">buy</span><span class="params">(CommercialPaperContext ctx, String issuer, String paperNumber, String currentOwner,</span></span><br><span class="line"><span class="params">            String newOwner, <span class="type">int</span> price, String purchaseDateTime)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Retrieve the current paper using key fields provided</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">paperKey</span> <span class="operator">=</span> State.makeKey(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123; paperNumber &#125;);</span><br><span class="line">        <span class="type">CommercialPaper</span> <span class="variable">paper</span> <span class="operator">=</span> ctx.paperList.getPaper(paperKey);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validate current owner</span></span><br><span class="line">        <span class="keyword">if</span> (!paper.getOwner().equals(currentOwner)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Paper &quot;</span> + issuer + paperNumber + <span class="string">&quot; is not owned by &quot;</span> + currentOwner);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// First buy moves state from ISSUED to TRADING</span></span><br><span class="line">        <span class="keyword">if</span> (paper.isIssued()) &#123;</span><br><span class="line">            paper.setTrading();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check paper is not already REDEEMED</span></span><br><span class="line">        <span class="keyword">if</span> (paper.isTrading()) &#123;</span><br><span class="line">            paper.setOwner(newOwner);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Paper &quot;</span> + issuer + paperNumber + <span class="string">&quot; is not trading. Current state = &quot;</span> + paper.getState());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the paper</span></span><br><span class="line">        ctx.paperList.updatePaper(paper);</span><br><span class="line">        <span class="keyword">return</span> paper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Redeem commercial paper</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;Context&#125; ctx the transaction context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;String&#125; issuer commercial paper issuer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;Integer&#125; paperNumber paper number for this issuer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;String&#125; redeemingOwner redeeming owner of paper</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;String&#125; redeemDateTime time paper was redeemed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transaction</span></span><br><span class="line">    <span class="keyword">public</span> CommercialPaper <span class="title function_">redeem</span><span class="params">(CommercialPaperContext ctx, String issuer, String paperNumber, String redeemingOwner,</span></span><br><span class="line"><span class="params">            String redeemDateTime)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">paperKey</span> <span class="operator">=</span> CommercialPaper.makeKey(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123; paperNumber &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">CommercialPaper</span> <span class="variable">paper</span> <span class="operator">=</span> ctx.paperList.getPaper(paperKey);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check paper is not REDEEMED</span></span><br><span class="line">        <span class="keyword">if</span> (paper.isRedeemed()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Paper &quot;</span> + issuer + paperNumber + <span class="string">&quot; already redeemed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Verify that the redeemer owns the commercial paper before redeeming it</span></span><br><span class="line">        <span class="keyword">if</span> (paper.getOwner().equals(redeemingOwner)) &#123;</span><br><span class="line">            paper.setOwner(paper.getIssuer());</span><br><span class="line">            paper.setRedeemed();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Redeeming owner does not own paper&quot;</span> + issuer + paperNumber);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.paperList.updatePaper(paper);</span><br><span class="line">        <span class="keyword">return</span> paper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-应用"><a href="#3-4-应用" class="headerlink" title="3.4 应用"></a>3.4 应用</h3><h4 id="3-4-1-基本流程"><a href="#3-4-1-基本流程" class="headerlink" title="3.4.1 基本流程"></a>3.4.1 基本流程</h4><ul>
<li><p>应用程序如何调用商业票据智能合约的简化图表：</p>
<p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681609886914.png" alt="1681609886914"></p>
</li>
<li><p>应用程序必须遵循六个基本步骤来提交交易：</p>
<ul>
<li>从钱包中选择一个身份</li>
<li>连接到网关</li>
<li>访问所需的网络</li>
<li>构建智能合约的交易请求</li>
<li>将交易提交到网络</li>
<li>处理响应</li>
</ul>
</li>
</ul>
<h2 id="4-工作流程"><a href="#4-工作流程" class="headerlink" title="4. 工作流程"></a>4. 工作流程</h2><p><img src="/../img/fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0.assets/1681614315146.png" alt="1681614315146"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://tangsmallrong.github.io">thr</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://tangsmallrong.github.io/2023/11/18/Fabric%E5%85%A5%E9%97%A8/">https://tangsmallrong.github.io/2023/11/18/Fabric%E5%85%A5%E9%97%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://tangsmallrong.github.io" target="_blank">thr's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/fabric/">fabric</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/11/18/Awk/" title="awk 编程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">awk 编程</div></div></a></div><div class="next-post pull-right"><a href="/2023/11/18/Jmeter/" title="Jmeter 压测"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Jmeter 压测</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Fabric"><span class="toc-text">Fabric</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-text">1. 关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%8C%BA%E5%9D%97%E9%93%BE%E7%BD%91%E7%BB%9C"><span class="toc-text">1.1 区块链网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%BA%AB%E4%BB%BD"><span class="toc-text">1.2 身份</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-PKI"><span class="toc-text">1.2.1 PKI</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E6%88%90%E5%91%98%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85-MSP"><span class="toc-text">1.3 成员服务提供者 (MSP)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-Peer-%E8%8A%82%E7%82%B9"><span class="toc-text">1.4 Peer 节点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-1-%E5%A4%9A%E8%B4%A6%E6%9C%AC"><span class="toc-text">1.4.1 多账本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-%E5%A4%9A%E9%93%BE%E7%A0%81"><span class="toc-text">1.4.2 多链码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-3-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%92%8C-Peer-%E8%8A%82%E7%82%B9"><span class="toc-text">1.4.3 应用程序和 Peer 节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-4-Peer-%E8%8A%82%E7%82%B9%E5%92%8C%E6%8E%92%E5%BA%8F%E8%8A%82%E7%82%B9"><span class="toc-text">1.4.4 Peer 节点和排序节点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-chaincode-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6"><span class="toc-text">1.5 chaincode 智能合约</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1-%E8%83%8C%E4%B9%A6"><span class="toc-text">1.5.1 背书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2-%E6%9C%89%E6%95%88%E4%BA%A4%E6%98%93"><span class="toc-text">1.5.2 有效交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-3-%E9%80%9A%E9%81%93"><span class="toc-text">1.5.3 通道</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-%E8%B4%A6%E6%9C%AC"><span class="toc-text">1.6 账本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-1-%E4%B8%96%E7%95%8C%E7%8A%B6%E6%80%81"><span class="toc-text">1.6.1 世界状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-2-%E5%8C%BA%E5%9D%97%E9%93%BE"><span class="toc-text">1.6.2 区块链</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-3-%E5%8C%BA%E5%9D%97"><span class="toc-text">1.6.3 区块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-4-%E4%BA%A4%E6%98%93"><span class="toc-text">1.6.4 交易</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-%E6%8E%92%E5%BA%8F%E6%9C%8D%E5%8A%A1"><span class="toc-text">1.7 排序服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-1-%E6%8E%92%E5%BA%8F%E8%8A%82%E7%82%B9%E5%92%8C%E4%BA%A4%E6%98%93%E6%B5%81%E7%A8%8B"><span class="toc-text">1.7.1 排序节点和交易流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-2-%E6%8E%92%E5%BA%8F%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-text">1.7.2 排序服务的实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%85%A5%E9%97%A8"><span class="toc-text">2. 入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83"><span class="toc-text">2.1 配置环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-ubuntu-%E8%81%94%E7%BD%91"><span class="toc-text">2.1.1 ubuntu 联网</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-apt-%E6%8D%A2%E6%BA%90"><span class="toc-text">2.1.2 apt 换源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-%E5%AE%89%E8%A3%85-docker"><span class="toc-text">2.1.3 安装 docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-4-%E5%AE%89%E8%A3%85-golang"><span class="toc-text">2.1.4 安装 golang</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-5-docker-%E5%8A%A0%E9%80%9F%E5%99%A8"><span class="toc-text">2.1.5 docker 加速器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-6-%E5%AE%89%E8%A3%85fabric-sample"><span class="toc-text">2.1.6 安装fabric-sample</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%BC%80%E5%8F%91"><span class="toc-text">3. 开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%88%86%E6%9E%90"><span class="toc-text">3.1 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E5%95%86%E4%B8%9A%E7%A5%A8%E6%8D%AE"><span class="toc-text">3.1.1 商业票据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E4%BA%A4%E6%98%93"><span class="toc-text">3.1.2 交易</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%B5%81%E7%A8%8B%E5%92%8C%E6%95%B0%E6%8D%AE%E8%AE%BE%E8%AE%A1"><span class="toc-text">3.2 流程和数据设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">3.2.1 生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E8%B4%A6%E6%9C%AC%E7%8A%B6%E6%80%81"><span class="toc-text">3.2.2 账本状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-%E7%8A%B6%E6%80%81%E9%94%AE%E5%80%BC"><span class="toc-text">3.2.3 状态键值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-%E9%80%BB%E8%BE%91%E8%A1%A8%E7%A4%BA"><span class="toc-text">3.2.3 逻辑表示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4-%E7%89%A9%E7%90%86%E8%A1%A8%E7%8E%B0"><span class="toc-text">3.2.4 物理表现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%A4%84%E7%90%86"><span class="toc-text">3.3 智能合约处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%BA%94%E7%94%A8"><span class="toc-text">3.4 应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-1-%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="toc-text">3.4.1 基本流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-text">4. 工作流程</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By thr</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>